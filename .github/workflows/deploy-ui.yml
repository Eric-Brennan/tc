name: Deploy UI to Azure Static Web Apps

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.ts'
      - '.github/workflows/deploy-ui.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  AZURE_STATIC_WEB_APP_NAME: 'tc'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Node ${{ env.NODE_VERSION }} Environment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: 'Install Dependencies and Build'
      run: |
        npm install
        npm run build
        cp staticwebapp.config.json dist/

    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Get Static Web App Deployment Token'
      id: static-web-app-token
      run: |
        TOKEN=$(az staticwebapp secrets list --name ${{ env.AZURE_STATIC_WEB_APP_NAME }} --query "properties.apiKey" -o tsv)
        echo "::add-mask::$TOKEN"
        echo "deployment-token=$TOKEN" >> $GITHUB_OUTPUT

    - name: 'Deploy to Azure Static Web Apps'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ steps.static-web-app-token.outputs.deployment-token }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: '/dist'
        output_location: ''
        skip_app_build: true

    - name: 'Logout from Azure'
      run: az logout
